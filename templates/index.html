<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traffic Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ðŸš¦ Traffic Monitoring Dashboard</h1>

    <form id="uploadForm" class="flex flex-col items-center space-y-4">
      <input type="file" id="videoFile" name="video" accept="video/*" required>
      <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Upload Video</button>
    </form>

    <div id="loader" class="hidden mt-6 flex justify-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
    </div>

    <div id="liveTracking" class="hidden mt-6 flex flex-col items-center">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Live Tracking:</h2>
      <div class="flex items-start">
        <img id="videoFrame" class="rounded-lg shadow-inner" width="400">
        <div id="trafficLight" class="ml-6 flex flex-col items-center">
          <div id="redLight" class="w-8 h-8 rounded-full bg-gray-300 mb-2"></div>
          <div id="greenLight" class="w-8 h-8 rounded-full bg-gray-300"></div>
        </div>
      </div>
      <p id="liveCount" class="mt-2 text-gray-800 text-md"></p>
    </div>

    <div id="result" class="hidden mt-6 bg-gray-50 p-4 rounded-lg shadow-inner">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Analysis Result:</h2>
      <p id="avgCount" class="text-gray-800 text-md"></p>
      <p id="status" class="text-gray-800 text-md"></p>
    </div>
  </div>

  <script>
    document.getElementById("uploadForm").addEventListener("submit", async e => {
      e.preventDefault();
      const fileInput = document.getElementById("videoFile");
      if (!fileInput.files.length) { alert("Please select a video file first!"); return; }
      const formData = new FormData();
      formData.append("video", fileInput.files[0]);

      document.getElementById("loader").classList.remove("hidden");
      document.getElementById("liveTracking").classList.add("hidden");
      document.getElementById("result").classList.add("hidden");

      const res = await fetch("/upload", { method: "POST", body: formData });
      const data = await res.json();
      const videoPath = encodeURIComponent(data.videoPath);

      document.getElementById("liveTracking").classList.remove("hidden");
      const videoFrame = document.getElementById("videoFrame");
      const liveCount = document.getElementById("liveCount");

      const pollFrame = async () => {
        const frameRes = await fetch(`/video_frame?video=${videoPath}`);
        if (frameRes.status === 200) {
          const frameData = await frameRes.json();
          videoFrame.src = "data:image/jpeg;base64," + frameData.frame;
          liveCount.textContent = `Cars in this frame: ${frameData.count}`;

          // Traffic light logic
          if (frameData.count > 4) {
            document.getElementById("redLight").classList.add("bg-red-600");
            document.getElementById("greenLight").classList.remove("bg-green-600");
            document.getElementById("greenLight").classList.add("bg-gray-300");
          } else {
            document.getElementById("greenLight").classList.add("bg-green-600");
            document.getElementById("redLight").classList.remove("bg-red-600");
            document.getElementById("redLight").classList.add("bg-gray-300");
          }
        }
        setTimeout(pollFrame, 100);
      };
      pollFrame();

      const pollResult = async () => {
        const res = await fetch(`/final_result?video=${videoPath}`);
        const resultData = await res.json();
        if (resultData.status === "done") {
          document.getElementById("avgCount").textContent = `Average Car Count: ${resultData.average_car_count.toFixed(2)}`;
          document.getElementById("status").textContent = `Average Vehicle Speed: ${resultData.average_vehicle_speed.toFixed(2)} m/s`;
          document.getElementById("result").classList.remove("hidden");
          document.getElementById("loader").classList.add("hidden");
        } else {
          setTimeout(pollResult, 1000);
        }
      };
      pollResult();
    });
  </script>
</body>
</html>
